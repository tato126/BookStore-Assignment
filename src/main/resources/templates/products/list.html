<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
  <meta charset="UTF-8"/>
  <title>ìƒí’ˆ ëª©ë¡</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px 12px; border-bottom: 1px solid #e5e7eb; text-align: left; }
    th { background: #f9fafb; }
    .toolbar { margin-bottom: 16px; display: flex; gap: 8px; }
    .btn { display:inline-block; padding:8px 12px; border:1px solid #d1d5db; border-radius:8px; text-decoration:none; }
    select { padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; background: white; }
    .category-filter { display: flex; flex-wrap: wrap; align-items: center; gap: 8px; }
    .category-filter button { padding: 8px 12px; border-radius: 6px; border: 1px solid #d1d5db; background: #f9fafb; cursor: pointer; }
    .category-filter button:hover { background: #e5e7eb; }
    .category-panel { margin: 16px 0; padding: 16px; border:1px solid #e5e7eb; border-radius: 12px; background: #f9fafb; }
    .category-panel h2 { margin-top: 0; font-size: 18px; }
    .category-tree { list-style: none; padding-left: 0; margin: 0; }
    .category-tree ul { list-style: none; padding-left: 18px; margin: 6px 0 0; }
    .category-tree li { margin: 4px 0; }
    .category-badge { display: inline-block; background: #e0e7ff; color: #4338ca; font-size: 12px; padding: 2px 6px; border-radius: 999px; margin-left: 6px; }

    /* í˜ì´ì§€ë„¤ì´ì…˜ ìŠ¤íƒ€ì¼ */
    .pagination-container {
      margin-top: 24px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
    }
    .pagination-info {
      color: #6b7280;
      font-size: 14px;
    }
    .pagination {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .page-link {
      display: inline-block;
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      text-decoration: none;
      color: #374151;
      transition: all 0.2s;
    }
    .page-link:hover:not(.disabled):not(.active) {
      background: #f3f4f6;
      border-color: #9ca3af;
    }
    .page-link.active {
      background: #3b82f6;
      color: white;
      border-color: #3b82f6;
      font-weight: 600;
    }
    .page-link.disabled {
      color: #d1d5db;
      cursor: not-allowed;
      pointer-events: none;
    }
  </style>
</head>
<body>
<h1>í˜„ì¬ íŒë§¤ ì¤‘ì¸ ë„ì„œ ğŸ“š</h1>

<div class="toolbar">
  <a class="btn" th:href="@{/admin/product/register}">+ ìƒí’ˆ ë“±ë¡</a>
  <a class="btn" th:href="@{/products/list}">í™ˆìœ¼ë¡œ</a>
  <form id="categoryFilterForm" class="category-filter" th:action="@{/}" method="get">
    <select id="filterLargeCategory" name="largeCategoryId">
      <option value="" th:selected="${selectedLargeCategoryId == null}">ëŒ€ë¶„ë¥˜ ì „ì²´</option>
      <option th:each="category : ${largeCategories}"
              th:value="${category.id}"
              th:text="${category.name}"
              th:selected="${selectedLargeCategoryId != null and selectedLargeCategoryId == category.id}"></option>
    </select>

    <select id="filterMediumCategory" name="mediumCategoryId"
            th:disabled="${selectedLargeCategoryId == null}">
      <option value="" th:selected="${selectedMediumCategoryId == null}">ì¤‘ë¶„ë¥˜ ì „ì²´</option>
      <option th:each="category : ${initialMediumCategories}"
              th:value="${category.id}"
              th:text="${category.name}"
              th:selected="${selectedMediumCategoryId != null and selectedMediumCategoryId == category.id}"></option>
    </select>

    <select id="filterSmallCategory" name="smallCategoryId"
            th:disabled="${selectedMediumCategoryId == null}">
      <option value="" th:selected="${selectedSmallCategoryId == null}">ì†Œë¶„ë¥˜ ì „ì²´</option>
      <option th:each="category : ${initialSmallCategories}"
              th:value="${category.id}"
              th:text="${category.name}"
              th:selected="${selectedSmallCategoryId != null and selectedSmallCategoryId == category.id}"></option>
    </select>

    <button type="submit">ì¡°íšŒ</button>
    <button type="button" id="resetCategoryFilter">ì´ˆê¸°í™”</button>
  </form>
</div>

<div class="category-panel" th:if="${categoryTree != null}">
  <h2>ì¹´í…Œê³ ë¦¬ êµ¬ì¡°</h2>
  <p style="color:#4b5563; font-size:14px; margin-bottom:12px;">í˜„ì¬ ì‚¬ìš© ì¤‘ì¸ ëŒ€ Â· ì¤‘ Â· ì†Œ ë¶„ë¥˜ ì „ì²´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆì–´ìš”.</p>
  <ul class="category-tree">
    <li th:each="large : ${categoryTree}">
      <strong th:text="${large.name}">ë¬¸í•™</strong>
      <span class="category-badge">ëŒ€ë¶„ë¥˜</span>
      <ul>
        <li th:each="medium : ${large.children}">
          <span th:text="${medium.name}">í•œêµ­ì†Œì„¤</span>
          <span class="category-badge" style="background:#dcfce7; color:#166534;">ì¤‘ë¶„ë¥˜</span>
          <ul>
            <li th:each="small : ${medium.children}">
              <span th:text="${small.name}">í˜„ëŒ€ í•œêµ­ì†Œì„¤</span>
              <span class="category-badge" style="background:#fee2e2; color:#991b1b;">ì†Œë¶„ë¥˜</span>
            </li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</div>

<table>
  <thead>
  <tr>
    <th>ID</th>
    <th>ìƒí’ˆëª…</th>
    <th>ì±… í‘œì§€</th>
    <th>ì„¤ëª…</th>
    <th>ê°€ê²©</th>
    <th>ì¬ê³ </th>
    <th>ì¹´í…Œê³ ë¦¬</th>
    <th>ë“±ë¡ì¼</th>
  </tr>
  </thead>
  <tbody>
  <tr th:each="p : ${products}">
    <td th:text="${p.productId}">1</td>
    <td>
      <a th:href="@{|/products/${p.productId}|}" th:text="${p.productName}">ì˜ˆì‹œìƒí’ˆ</a>
    </td>
    <td>
      <img th:src="${p.imageUrl}" alt="ì±… ì´ë¯¸ì§€" style="max-width:80px; height:auto; display:block; margin-top:4px;"/>
    </td>
    <td th:text="${p.description}">ì„¤ëª…</td>
    <td th:text="${#numbers.formatInteger(p.price, 0, 'COMMA')} + 'ì›'">10,000ì›</td>
    <td th:text="${p.stockQuantity}">5</td>
    <td th:text="${p.categoryPath}">ë¬¸í•™ > í•œêµ­ì†Œì„¤ > í˜„ëŒ€ í•œêµ­ì†Œì„¤</td>
    <td th:text="${#temporals.format(p.createdAt, 'yyyyë…„ MMì›” ddì¼ HHì‹œ mmë¶„ ssì´ˆ')}">2025ë…„ 09ì›” 14ì¼ 18ì‹œ 20ë¶„ 12ì´ˆ</td>
  </tr>
  <tr th:if="${#lists.isEmpty(products)}">
    <td colspan="8">ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</td>
  </tr>
  </tbody>
</table>

<!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
<div class="pagination-container" th:if="${page != null && page.totalPages > 0}">
  <!-- í˜ì´ì§€ ì •ë³´ -->
  <div class="pagination-info">
    ì „ì²´ <strong th:text="${page.totalElements}">0</strong>ê°œ ìƒí’ˆ ì¤‘
    <strong th:text="${page.number * page.size + 1}">1</strong> -
    <strong th:text="${(page.number + 1) * page.size > page.totalElements ? page.totalElements : (page.number + 1) * page.size}">30</strong>ê°œ í‘œì‹œ
    (í˜ì´ì§€ <strong th:text="${page.number + 1}">1</strong> / <strong th:text="${page.totalPages}">1</strong>)
  </div>

  <!-- í˜ì´ì§€ ë„¤ë¹„ê²Œì´ì…˜ -->
  <div class="pagination">
    <!-- ì´ì „ ë²„íŠ¼ -->
    <a th:href="@{/(page=${page.number - 1}, size=${page.size})}"
       th:class="${page.hasPrevious()} ? 'page-link' : 'page-link disabled'"
       th:if="${page.hasPrevious() || page.number > 0}">
      â† ì´ì „
    </a>
    <span class="page-link disabled" th:unless="${page.hasPrevious() || page.number > 0}">
      â† ì´ì „
    </span>

    <!-- í˜ì´ì§€ ë²ˆí˜¸ë“¤ -->
    <th:block th:with="
      startPage=${page.number - 2 < 0 ? 0 : page.number - 2},
      endPage=${page.number + 2 >= page.totalPages ? page.totalPages - 1 : page.number + 2}">

      <!-- ì²« í˜ì´ì§€ -->
      <a th:if="${startPage > 0}"
         th:href="@{/(page=0, size=${page.size})}"
         class="page-link">1</a>
      <span th:if="${startPage > 1}" class="page-link disabled">...</span>

      <!-- ì¤‘ê°„ í˜ì´ì§€ë“¤ -->
      <th:block th:each="i : ${#numbers.sequence(startPage, endPage)}">
        <a th:href="@{/(page=${i}, size=${page.size})}"
           th:text="${i + 1}"
           th:class="${i == page.number} ? 'page-link active' : 'page-link'">1</a>
      </th:block>

      <!-- ë§ˆì§€ë§‰ í˜ì´ì§€ -->
      <span th:if="${endPage < page.totalPages - 2}" class="page-link disabled">...</span>
      <a th:if="${endPage < page.totalPages - 1}"
         th:href="@{/(page=${page.totalPages - 1}, size=${page.size})}"
         th:text="${page.totalPages}"
         class="page-link">10</a>
    </th:block>

    <!-- ë‹¤ìŒ ë²„íŠ¼ -->
    <a th:href="@{/(page=${page.number + 1}, size=${page.size})}"
       th:class="${page.hasNext()} ? 'page-link' : 'page-link disabled'"
       th:if="${page.hasNext()}">
      ë‹¤ìŒ â†’
    </a>
    <span class="page-link disabled" th:unless="${page.hasNext()}">
      ë‹¤ìŒ â†’
    </span>
  </div>
</div>

</body>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('categoryFilterForm');
    if (!form) {
      return;
    }

    const largeCategory = document.getElementById('filterLargeCategory');
    const mediumCategory = document.getElementById('filterMediumCategory');
    const smallCategory = document.getElementById('filterSmallCategory');
    const resetButton = document.getElementById('resetCategoryFilter');

    function resetSelect(selectElement, placeholder) {
      selectElement.innerHTML = '';
      const option = document.createElement('option');
      option.value = '';
      option.textContent = placeholder;
      selectElement.appendChild(option);
      selectElement.value = '';
    }

    function enableSelect(selectElement, enabled) {
      if (enabled) {
        selectElement.removeAttribute('disabled');
      } else {
        selectElement.setAttribute('disabled', 'disabled');
      }
    }

    async function fetchCategories(level, parentId) {
      const params = new URLSearchParams({ level });
      if (parentId) {
        params.append('parentId', parentId);
      }

      const response = await fetch(`/api/categories?${params.toString()}`);
      if (!response.ok) {
        throw new Error('ì¹´í…Œê³ ë¦¬ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
      }
      return response.json();
    }

    function populateSelect(selectElement, categories, placeholder) {
      resetSelect(selectElement, placeholder);
      categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category.id;
        option.textContent = category.name;
        selectElement.appendChild(option);
      });
    }

    largeCategory.addEventListener('change', async () => {
      const largeId = largeCategory.value;
      resetSelect(mediumCategory, 'ì¤‘ë¶„ë¥˜ ì „ì²´');
      resetSelect(smallCategory, 'ì†Œë¶„ë¥˜ ì „ì²´');
      enableSelect(smallCategory, false);

      if (!largeId) {
        enableSelect(mediumCategory, false);
        return;
      }

      try {
        const categories = await fetchCategories('MEDIUM', largeId);
        populateSelect(mediumCategory, categories, 'ì¤‘ë¶„ë¥˜ ì „ì²´');
        enableSelect(mediumCategory, true);
      } catch (error) {
        alert(error.message);
      }
    });

    mediumCategory.addEventListener('change', async () => {
      const mediumId = mediumCategory.value;
      resetSelect(smallCategory, 'ì†Œë¶„ë¥˜ ì „ì²´');

      if (!mediumId) {
        enableSelect(smallCategory, false);
        return;
      }

      try {
        const categories = await fetchCategories('SMALL', mediumId);
        populateSelect(smallCategory, categories, 'ì†Œë¶„ë¥˜ ì „ì²´');
        enableSelect(smallCategory, true);
      } catch (error) {
        alert(error.message);
      }
    });

    resetButton.addEventListener('click', () => {
      largeCategory.value = '';
      resetSelect(mediumCategory, 'ì¤‘ë¶„ë¥˜ ì „ì²´');
      resetSelect(smallCategory, 'ì†Œë¶„ë¥˜ ì „ì²´');
      enableSelect(mediumCategory, false);
      enableSelect(smallCategory, false);
      form.submit();
    });

    // í˜ì´ì§€ ì§„ì… ì‹œ ì„ íƒê°’ì— ë§ì¶° ì…€ë ‰íŠ¸ í™œì„±í™” ì¡°ì •
    if (!largeCategory.value) {
      enableSelect(mediumCategory, false);
      enableSelect(smallCategory, false);
    } else if (!mediumCategory.value) {
      enableSelect(mediumCategory, true);
      enableSelect(smallCategory, false);
    } else if (!smallCategory.value) {
      enableSelect(mediumCategory, true);
      enableSelect(smallCategory, true);
    }
  });
</script>
</html>
